<html>
<head>
</head>
<body>
<div class="grid">
  <div id="group-1">
    <input class="button" type="checkbox" value="1"/>
    <input class="button" type="checkbox" value="2"/>
    <input class="button" type="checkbox" value="3"/>
    <input class="button" type="checkbox" value="4"/>
    <input class="button" type="checkbox" value="5"/>
    <input class="button" type="checkbox" value="6"/>
    <input class="button" type="checkbox" value="7"/>
    <input class="button" type="checkbox" value="8"/>
    <input class="button" type="checkbox" value="9"/>
    <input class="button" type="checkbox" value="10"/>
    <input class="button" type="checkbox" value="11"/>
    <input class="button" type="checkbox" value="12"/>
  </div>
    <div id="group-2">
    <input class="button" type="checkbox" value="1"/>
    <input class="button" type="checkbox" value="2"/>
    <input class="button" type="checkbox" value="3"/>
    <input class="button" type="checkbox" value="4"/>
    <input class="button" type="checkbox" value="5"/>
    <input class="button" type="checkbox" value="6"/>
    <input class="button" type="checkbox" value="7"/>
    <input class="button" type="checkbox" value="8"/>
    <input class="button" type="checkbox" value="9"/>
    <input class="button" type="checkbox" value="10"/>
    <input class="button" type="checkbox" value="11"/>
    <input class="button" type="checkbox" value="12"/>
  </div>
  <div id="group-3">
    <input class="button" type="checkbox" value="1"/>
    <input class="button" type="checkbox" value="2"/>
    <input class="button" type="checkbox" value="3"/>
    <input class="button" type="checkbox" value="4"/>
    <input class="button" type="checkbox" value="5"/>
    <input class="button" type="checkbox" value="6"/>
    <input class="button" type="checkbox" value="7"/>
    <input class="button" type="checkbox" value="8"/>
    <input class="button" type="checkbox" value="9"/>
    <input class="button" type="checkbox" value="10"/>
    <input class="button" type="checkbox" value="11"/>
    <input class="button" type="checkbox" value="12"/>
  </div>
    <div id="group-4">
    <input class="button" type="checkbox" value="1"/>
    <input class="button" type="checkbox" value="2"/>
    <input class="button" type="checkbox" value="3"/>
    <input class="button" type="checkbox" value="4"/>
    <input class="button" type="checkbox" value="5"/>
    <input class="button" type="checkbox" value="6"/>
    <input class="button" type="checkbox" value="7"/>
    <input class="button" type="checkbox" value="8"/>
    <input class="button" type="checkbox" value="9"/>
    <input class="button" type="checkbox" value="10"/>
    <input class="button" type="checkbox" value="11"/>
    <input class="button" type="checkbox" value="12"/>
  </div>
</div>

<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>
<script>

// https://chromium.googlesource.com/external/WebKit_LayoutTests/+/master/webaudio/audiobuffersource-playbackrate.html
// window.onload = init;
var playbackRates, intervals = [];
var buffer;
var sampleRate = 44100.0;
// var numberOfNotes = 72; // play over a 6 octave range
 var noteDuration = 0.2;
//var noteSpacing = noteDuration + 0.005; // leave 5ms of silence between each "note"
// var lengthInSeconds = numberOfNotes * noteSpacing;
// var context = 0;
// var sinWaveBuffer = 0;

function createOneCycleSinWaveBuffer(frequency) {
    var duration = 1 / frequency;
    var sampleFrameLength = duration * sampleRate;
    
    var audioBuffer = context.createBuffer(2, sampleFrameLength, sampleRate);
    var n = audioBuffer.length;
    var channelL = audioBuffer.getChannelData(0);
    var channelR = audioBuffer.getChannelData(1);
    for (var i = 0; i < n; ++i) {
        channelL[i] = Math.sin(frequency * 2.0*Math.PI * i / sampleRate);
        channelR[i] = channelL[i];
    }
    return audioBuffer;
}

var context;
window.addEventListener('load', init, false);

function loadSound(url) {
  buffer = createOneCycleSinWaveBuffer(440.0);
  return Q(buffer); 
}

function loopSound(buffer) {
  var numberOfNotes = 12;

  for (var i = 0; i < numberOfNotes; i++) 
  {
    var semitone = i;
    var playbackRate = Math.pow(2, semitone / 12);

    var properties = { 
      buffer: buffer, 
      playbackRate: playbackRate, 
      duration: 0.2
    }

    playbackRates.push(properties);
  } 
}

function playSound(properties) {
  //buffer, time, playbackRate, duration
  //buffer = properties.buffer;
  time = context.currentTime;
  playbackRate = properties.playbackRate;
  duration = properties.duration;

  var source = context.createBufferSource(); // creates a sound source
  source.buffer = properties.buffer;         // tell the source which sound to play
  source.connect(context.destination);       // connect the source to the context's destination (the speakers)

  // Apply quick fade-in and fade-out to avoid clicks.
  // https://chromium.googlesource.com/external/WebKit_LayoutTests/+/master/webaudio/audiobuffersource-playbackrate.html
  var gainNode = context.createGainNode();
  gainNode.gain.value = 0;
  gainNode.gain.setValueAtTime(0, time);
  gainNode.gain.linearRampToValueAtTime(1, time + 0.005);
  gainNode.gain.setValueAtTime(1, time + duration - 0.005);
  gainNode.gain.linearRampToValueAtTime(0, time + duration);
  source.connect(gainNode);
  gainNode.connect(context.destination);

  source.playbackRate.value = playbackRate;
  source.loop = true;
  source.start(time);                           // play the source now
  source.stop(time + duration);
  return buffer;                             // note: on older systems, may have to use deprecated noteOn(time);
}

function playNotes($elem) {
    console.log($elem.attr('id'));
    setTimeout(function() { playNotes($elem) }, 2000);
}

function init() {
  try {
    // Fix up for prefixing
    window.AudioContext = window.AudioContext||window.webkitAudioContext;
    context = new AudioContext();
  }
  catch(e) {
  	console.log(e)
    console.log('Web Audio API is not supported in this browser');
  }

  var url = 'http://localhost:3000/sampleTone';
  loadSound(url).then(loopSound);

  $(".grid").children().each(function(index){
    var i = $(this);
    setTimeout(function() { 
      playNotes(i)
    }, index * 500);
  })
  // $(".button").click('click', function() {
  //   var properties = playbackRates[$(this).val()-1];
  //   playSound(properties)
  // })
}

</script>
</body>
</html>